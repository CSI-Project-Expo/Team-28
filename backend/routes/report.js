const express = require('express');
const router = express.Router();
const { triageIssue } = require('../services/triage');
const { runSandboxFix } = require('../services/sandbox');
const { createPullRequest, mergePullRequest } = require('../services/github');
const { sendManualReviewEmail } = require('../services/notification');

/**
 * POST /api/report
 *
 * Accepts an issue report and kicks off the full self-healing pipeline:
 *   1. AI triage â†’ AUTOMATED | MANUAL
 *   2. Sandbox fix generation (e2b + Claude Code)
 *   3. PR creation
 *   4. Auto-merge (AUTOMATED) or email notification (MANUAL)
 */
router.post('/report', async (req, res) => {
    try {
        const { title, description, stepsToReproduce, expectedBehavior, actualBehavior } = req.body;

        // â”€â”€ Validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!title || !description) {
            return res.status(400).json({
                success: false,
                message: 'Both "title" and "description" are required.',
            });
        }

        const issuePayload = {
            title,
            description,
            stepsToReproduce: stepsToReproduce || '',
            expectedBehavior: expectedBehavior || '',
            actualBehavior: actualBehavior || '',
        };

        console.log(`\nğŸ“¥  New issue reported: "${title}"`);

        // â”€â”€ Step 1: AI Triage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        console.log('ğŸ¤–  Running AI triageâ€¦');
        const triageResult = await triageIssue(issuePayload);
        console.log(`    Decision: ${triageResult.decision}  (confidence: ${triageResult.confidence})`);
        console.log(`    Reasoning: ${triageResult.reasoning}`);

        // â”€â”€ Step 2: Sandbox Fix Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        console.log('ğŸ“¦  Spinning up sandbox environmentâ€¦');
        const sandboxResult = await runSandboxFix(issuePayload, triageResult);
        console.log(`    Branch: ${sandboxResult.branch}`);

        // â”€â”€ Step 3: Create Pull Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        console.log('ğŸ”€  Creating Pull Requestâ€¦');
        const pr = await createPullRequest({
            title: `[Self-Heal] Fix: ${title}`,
            body: buildPRBody(issuePayload, triageResult, sandboxResult),
            branch: sandboxResult.branch,
        });
        console.log(`    PR #${pr.number}: ${pr.html_url}`);

        // â”€â”€ Step 4: Resolution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let resolution;
        if (triageResult.decision === 'AUTOMATED') {
            console.log('âœ…  Auto-merging PRâ€¦');
            await mergePullRequest(pr.number);
            resolution = 'merged';
        } else {
            console.log('ğŸ“§  Sending manual-review notificationâ€¦');
            await sendManualReviewEmail({
                issueTitle: title,
                prUrl: pr.html_url,
                prNumber: pr.number,
                reasoning: triageResult.reasoning,
            });
            resolution = 'pending_review';
        }

        return res.status(201).json({
            success: true,
            data: {
                triageDecision: triageResult.decision,
                confidence: triageResult.confidence,
                prNumber: pr.number,
                prUrl: pr.html_url,
                resolution,
            },
        });
    } catch (error) {
        console.error('âŒ  Pipeline error:', error);
        return res.status(500).json({
            success: false,
            message: 'Failed to process the issue report.',
            error: process.env.NODE_ENV === 'development' ? error.message : undefined,
        });
    }
});

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPRBody(issue, triage, sandbox) {
    return [
        `## ğŸ› ï¸ Self-Healing Fix`,
        '',
        `**Issue:** ${issue.title}`,
        `**Description:** ${issue.description}`,
        '',
        `### Triage`,
        `| Field | Value |`,
        `|-------|-------|`,
        `| Decision | \`${triage.decision}\` |`,
        `| Confidence | ${triage.confidence} |`,
        `| Reasoning | ${triage.reasoning} |`,
        '',
        `### Changes`,
        sandbox.summary || '_No summary available._',
        '',
        `---`,
        `_Generated by AI Self-Healing System_`,
    ].join('\n');
}

module.exports = router;
